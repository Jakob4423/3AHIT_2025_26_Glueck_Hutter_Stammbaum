@* 
    Startseite der Stammbaum-Anwendung.
    Zeigt ein Modal mit Register- und Login-Funktionalität.
    Nach erfolgreichem Login wird das Modal geschlossen.
	Glück
*@
@page "/"
@using ITP2Tree.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@inject ITP2Tree.Services.AuthService Auth

<PageTitle>Home - Stammbaum für Waisenkinder</PageTitle>

<h1 class="display-5">Willkommen zu Waisenkinder.Tree</h1>

@* Inhalt wenn angemeldet *@
<AuthorizeView>
	<Authorized Context="authContext">
		<div class="mt-5">
			<div class="alert alert-success">
				<h4>Du bist erfolgreich angemeldet!</h4>
				<p class="mb-0">Du kannst jetzt deinen persönlichen Stammbaum verwalten und erstellen.</p>
			</div>
			<div class="mt-4 d-flex gap-3">
				<a href="/tree" class="btn btn-primary btn-lg">Stammbaum ansehen</a>
				<a href="/protected" class="btn btn-outline-primary btn-lg">Personen verwalten</a>
			</div>
		</div>
	</Authorized>
	<NotAuthorized>
		@* Modal mit Register/Login Tabs *@
		@if (showModal)
		{
			<div class="modal-backdrop-custom" @onclick="CloseOnBackdrop">
				<div class="modal-card" @onclick:stopPropagation>
					<div class="d-flex mb-3 align-items-center">
						<button class="me-2" @onclick="SelectRegister">Registrieren</button>
						<button class="me-2" @onclick="SelectLogin">Login</button>
						<button class="btn btn-sm btn-link ms-auto" @onclick="CloseModal">×</button>
					</div>

					<div>
						@if (activeTab == "register")
						{
							<RegisterForm OnSuccess="OnRegistered" />
						}
						else
						{
							<LoginForm OnSuccess="OnLoggedIn" />
						}
					</div>
				</div>
			</div>
		}
	</NotAuthorized>
</AuthorizeView>

@code {
	/// <summary>
	/// Steuert, ob das Modal sichtbar ist.
	/// </summary>
	private bool showModal = true;

	/// <summary>
	/// Aktiver Tab: "register" oder "login".
	/// </summary>
	private string activeTab = "register";

	/// <summary>
	/// Wechselt zum angegebenen Tab.
	/// </summary>
	private void SelectTab(string tab)
	{
		activeTab = tab;
	}

	/// <summary>
	/// Wechselt zum Register-Tab.
	/// </summary>
	private void SelectRegister() => SelectTab("register");

	/// <summary>
	/// Wechselt zum Login-Tab.
	/// </summary>
	private void SelectLogin() => SelectTab("login");

	/// <summary>
	/// Schließt das Modal.
	/// </summary>
	private void CloseModal() => showModal = false;

	/// <summary>
	/// Schließt das Modal, wenn auf den Hintergrund geklickt wird.
	/// </summary>
	private void CloseOnBackdrop()
	{
		CloseModal();
	}

	/// <summary>
	/// Wird aufgerufen, wenn die Registrierung erfolgreich war.
	/// Wechselt zum Login-Tab, damit sich der Benutzer anmelden kann.
	/// </summary>
	private void OnRegistered()
	{
		activeTab = "login";
		StateHasChanged();
	}

	/// <summary>
	/// Wird aufgerufen, wenn der Login erfolgreich war.
	/// Schließt das Modal und zeigt den Willkommenstext.
	/// </summary>
	private void OnLoggedIn()
	{
		CloseModal();
		StateHasChanged();
	}
}

