@page "/tree"
@using ITP2Tree.Data
@using Microsoft.EntityFrameworkCore
@inject AppDBContext Db
@inject ITP2Tree.Services.AuthService Auth
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>Stammbaum erstellen</PageTitle>

@if (Auth.UserId is null)
{
    <p>Du bist nicht eingeloggt. Bitte <a href="/login">einloggen</a>.</p>
}
else 
{
    <h3>Stammbaum Editor</h3>
    <p class="text-muted">Ziehe Knoten, positioniere sie und exportiere als SVG.</p>

    @if (persons is null)
    {
        <p>Lade Personen …</p>
    }
    else if (persons.Count == 0)
    {
        <div class="alert alert-info">
            <p class="text-muted">Keine Personen gefunden. Füge Personen hinzu, um einen Stammbaum zu erstellen.</p>
            <a href="/protected" class="btn btn-primary">Personen verwalten</a>
        </div>
    }
    else
    {
        <div class="mb-3 d-flex gap-2">
            <button class="btn btn-primary" @onclick="InitEditor">Editor aktivieren</button>
            <button class="btn btn-outline-secondary" @onclick="ExportSvg">Export SVG</button>
        </div>

        <div class="card p-3">
            <svg id="treeSvg" width="900" height="600" style="border:1px solid rgba(0,0,0,0.06); background:#fff;">
                <!-- Verbindungen/Linien zwischen Verwandten -->
                @foreach (var connection in connections)
                {
                    <g>
                        <line x1="@connection.X1" y1="@connection.Y1" x2="@connection.X2" y2="@connection.Y2" stroke="#888" stroke-width="2" />
                        <!-- Label für Beziehungstyp in der Mitte der Linie -->
                        <text x="@((connection.X1 + connection.X2) / 2)" y="@((connection.Y1 + connection.Y2) / 2 - 5)" font-family="Segoe UI, system-ui" font-size="11" fill="#666" text-anchor="middle">@connection.Beziehungstyp</text>
                    </g>
                }
                
                <!-- Knoten -->
                @foreach (var n in nodes)
                {
                    <g class="node" transform="translate(@n.X,@n.Y)" data-id="@n.Id">
                        <rect x="-80" y="-18" width="160" height="36" rx="8" fill="#f3f6ff" stroke="#1e88ff" stroke-width="1" />
                        <text x="0" y="6" font-family="Segoe UI, system-ui" font-size="14" text-anchor="middle" fill="#062b80">@n.Label</text>
                    </g>
                }
            </svg>
        </div>
    }
}

@code {
    private List<Person>? persons;
    private List<Node> nodes = new();
    private List<Connection> connections = new();

    protected override async Task OnInitializedAsync()
    {
        if (Auth.UserId is not null)
        {
            persons = await Db.Personen
                .Where(p => p.BenutzerId == Auth.UserId.Value)
                .ToListAsync();
            
            if (persons != null)
            {
                int i = 0;
                foreach (var p in persons)
                {
                    nodes.Add(new Node { Id = p.Id, Label = p.Name ?? "(ohne Name)", X = 120 + (i % 4) * 220, Y = 60 + (i / 4) * 120 });
                    i++;
                }
                
                // Verbindungen basierend auf Verwandtschaftsbeziehungen
                await BuildConnections();
            }
        }
    }

    /// <summary>
    /// Erstellt Verbindungen zwischen Personen basierend auf den Verwandtschaftsbeziehungen
    /// </summary>
    private async Task BuildConnections()
    {
        connections.Clear();
        
        // Lade alle Verwandtschaftsbeziehungen für die Personen des aktuellen Benutzers
        var verwandtschaften = await Db.Verwandtschaften
            .Where(v => persons!.Select(p => p.Id).Contains(v.PersonAId) || 
                        persons!.Select(p => p.Id).Contains(v.PersonBId))
            .ToListAsync();
        
        foreach (var v in verwandtschaften)
        {
            var nodeA = nodes.FirstOrDefault(n => n.Id == v.PersonAId);
            var nodeB = nodes.FirstOrDefault(n => n.Id == v.PersonBId);
            
            if (nodeA != null && nodeB != null)
            {
                connections.Add(new Connection
                {
                    FromNodeId = v.PersonAId,
                    ToNodeId = v.PersonBId,
                    X1 = nodeA.X,
                    Y1 = nodeA.Y,
                    X2 = nodeB.X,
                    Y2 = nodeB.Y,
                    Beziehungstyp = v.Beziehungstyp
                });
            }
        }
    }

    private async Task InitEditor()
    {
        await JS.InvokeVoidAsync("TreeEditor.init", "treeSvg");
    }

    private async Task ExportSvg()
    {
        var svg = await JS.InvokeAsync<string>("TreeEditor.getSvgHtml", "treeSvg");
        if (!string.IsNullOrEmpty(svg))
        {
            var href = "data:image/svg+xml;charset=utf-8," + Uri.EscapeDataString(svg);
            // trigger download
            await JS.InvokeVoidAsync("(function(h){var a=document.createElement('a');a.href=h;a.download='stammbaum.svg';document.body.appendChild(a);a.click();a.remove();})(" + "'" + href + "'" + ")");
        }
    }

    private class Node
    {
        public int Id { get; set; }
        public string Label { get; set; } = string.Empty;
        public double X { get; set; }
        public double Y { get; set; }
    }

    private class Connection
    {
        public int FromNodeId { get; set; }
        public int ToNodeId { get; set; }
        public double X1 { get; set; }
        public double Y1 { get; set; }
        public double X2 { get; set; }
        public double Y2 { get; set; }
        public string Beziehungstyp { get; set; } = string.Empty;
    }
}
