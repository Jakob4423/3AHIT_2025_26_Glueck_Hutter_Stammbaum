@page "/protected"
@* Geschützte Seite für angemeldete Benutzer zur Verwaltung ihrer Familienmitglieder *@
@using ITP2Tree.Data
@using ITP2Tree.Components.Shared
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@inject AppDBContext Db
@inject ITP2Tree.Services.AuthService Auth
@inject NavigationManager NavigationManager

@if (Auth.UserId is null)
{
    <p>Du bist nicht eingeloggt. Bitte <a href="/login">einloggen</a>.</p>
}
else if (user == null)
{
    <p>Lade Benutzerdaten...</p>
}
else
{
    <div class="d-flex align-items-center mb-3">
        <div>
            <h3 class="mb-0">Willkommen, @user.Name</h3>
            <div class="text-muted">@user.Email</div>
        </div>
        <div class="ms-auto d-flex gap-2 align-items-center">
            <input placeholder="Suchen..." class="form-control form-control-sm" style="width:240px" @bind="searchTerm" />
            <button class="btn btn-outline-secondary" @onclick="Logout">Logout</button>
            <button class="btn btn-primary" @onclick="OpenAddModal">Person hinzufügen</button>
            @if (!string.IsNullOrEmpty(csvHref))
            {
                <a class="d-none" href="@csvHref" download="personen.csv">download</a>
            }
        </div>
    </div>

    <hr />

    <h4 class="mb-3">Deine Personen</h4>
    @if (persons is null || persons.Count == 0 || FilteredPersons.Count == 0)
    {
        <p class="text-muted">Keine Personen vorhanden. Nutze "Person hinzufügen" um loszulegen.</p>
    }
    else
    {
        <div class="person-grid">
            @foreach (var p in FilteredPersons)
            {
                <PersonCard Person="p" OnEdit="OpenEditModal" OnDelete="RequestDeletePerson" />
            }
        </div>
    }

    @if (showAddModal)
    {
        <div class="modal-backdrop-custom" @onclick="CloseAddModal">
            <div class="modal-card" @onclick:stopPropagation>
                <div class="d-flex mb-3">
                    <h5 class="mb-0">Person hinzufügen</h5>
                    <button class="btn btn-sm btn-link ms-auto" @onclick="CloseAddModal">×</button>
                </div>

                <EditForm EditContext="personEditContext" OnValidSubmit="HandleAddPerson">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label>Name</label>
                            <InputText @bind-Value="newPerson.Name" class="form-control" />
                            <ValidationMessage For="() => newPerson.Name" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>Geburtsort</label>
                            <InputText @bind-Value="newPerson.Geburtsort" class="form-control" />
                            <ValidationMessage For="() => newPerson.Geburtsort" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label>Geburtsdatum</label>
                            <InputText @bind-Value="newPerson.Geburtsdatum" class="form-control" />
                            <ValidationMessage For="() => newPerson.Geburtsdatum" />
                        </div>
                        <div class="col-md-6 mb-2">
                            <label>Bekannte Verwandte (Komma-getrennt)</label>
                            <InputText @bind-Value="newPerson.Verwandte" class="form-control" />
                            <ValidationMessage For="() => newPerson.Verwandte" />
                        </div>
                    </div>

                    <div class="mb-2">
                        <label>Notizen</label>
                        <InputTextArea @bind-Value="newPerson.Notizen" class="form-control" />
                    </div>

                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-primary" type="submit">Speichern</button>
                        <button class="btn btn-outline-secondary" type="button" @onclick="CloseAddModal">Abbrechen</button>
                    </div>
                </EditForm>
            </div>
        </div>
    }
}
@code {
    private Benutzer? user;
    private Person newPerson = new();
    private List<Person>? persons;
    private EditContext? personEditContext;
    private ValidationMessageStore? validationMessageStore;
    private bool showAddModal = false;
    private bool showEditModal = false;
    private Person? editPerson;
    private bool showConfirmDelete = false;
    private Person? personToDelete;
    private string searchTerm = string.Empty;
    private string? csvHref;

    // Verwandtschaftsverwaltung
    private bool showRelationshipModal = false;
    private Person? selectedPerson;
    private List<Verwandtschaft>? selectedPersonRelationships;
    private int newRelationshipPersonId = 0;
    private string newRelationshipType = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        if (Auth.UserId is not null)
        {
            user = await Db.Benutzer.FindAsync(Auth.UserId.Value);
            // load user's Personen
            persons = await Db.Personen.Where(p => p.BenutzerId == Auth.UserId.Value).ToListAsync();
            personEditContext = new EditContext(newPerson);
            validationMessageStore = new ValidationMessageStore(personEditContext);
        }
        // open add-person modal if query string contains open=persons
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("open", out var val))
        {
            if (val == "persons")
            {
                // prepare new person and show modal
                newPerson = new Person();
                personEditContext = new EditContext(newPerson);
                validationMessageStore = new ValidationMessageStore(personEditContext);
                showAddModal = true;
            }
        }
    }

    private List<Person> FilteredPersons =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? (persons ?? new List<Person>())
            : (persons ?? new List<Person>()).Where(p =>
                (p.Name ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (p.Geburtsort ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (p.Verwandte ?? string.Empty).Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    private void Logout()
    {
        Auth.SignOut();
        NavigationManager.NavigateTo("/");
    }

    private async Task HandleAddPerson()
    {
        // Clear previous messages
        validationMessageStore?.Clear();

        // Count non-empty fields among the five information fields
        var filled = 0;
        if (!string.IsNullOrWhiteSpace(newPerson.Name)) filled++;
        if (!string.IsNullOrWhiteSpace(newPerson.Geburtsort)) filled++;
        if (!string.IsNullOrWhiteSpace(newPerson.Geburtsdatum)) filled++;
        if (!string.IsNullOrWhiteSpace(newPerson.Verwandte)) filled++;
        if (!string.IsNullOrWhiteSpace(newPerson.Notizen)) filled++;

        if (filled < 5)
        {
            var field = new FieldIdentifier(newPerson, nameof(newPerson.Name));
            validationMessageStore?.Add(field, "Bitte mindestens fünf Informationen eingeben (fülle alle Felder).\n");
            personEditContext?.NotifyValidationStateChanged();
            return;
        }

        // assign owner and save
        newPerson.BenutzerId = Auth.UserId!.Value;
        Db.Personen.Add(newPerson);
        await Db.SaveChangesAsync();

        // reload list and reset form
        persons = await Db.Personen.Where(p => p.BenutzerId == Auth.UserId.Value).ToListAsync();
        newPerson = new Person();
        personEditContext = new EditContext(newPerson);
        validationMessageStore = new ValidationMessageStore(personEditContext);
        showAddModal = false;
        StateHasChanged();
    }

    private void OpenAddModal()
    {
        newPerson = new Person();
        personEditContext = new EditContext(newPerson);
        validationMessageStore = new ValidationMessageStore(personEditContext);
        showAddModal = true;
    }

    // If navigation contains ?open=persons the page will automatically open the Add Person modal

    private void CloseAddModal()
    {
        showAddModal = false;
    }

    private async Task OnDeletePerson(Person p)
    {
        await JS.InvokeVoidAsync("console.log", $"OnDeletePerson called for {p?.Name} (Id={p?.Id})");
        if (p != null)
        {
            Db.Personen.Remove(p);
            await Db.SaveChangesAsync();
            persons = await Db.Personen.Where(x => x.BenutzerId == Auth.UserId).ToListAsync();
            StateHasChanged();
        }
    }

    private async Task OpenEditModal(Person p)
    {
        await JS.InvokeVoidAsync("console.log", $"OpenEditModal called for {p?.Name} (Id={p?.Id})");
        if (p != null)
        {
            // create a detached copy to edit
            editPerson = new Person
            {
                Id = p.Id,
                BenutzerId = p.BenutzerId,
                Name = p.Name ?? string.Empty,
                Geburtsort = p.Geburtsort ?? string.Empty,
                Geburtsdatum = p.Geburtsdatum ?? string.Empty,
                Verwandte = p.Verwandte ?? string.Empty,
                Notizen = p.Notizen
            };
            showEditModal = true;
        }
    }

    private async Task OnSaveEdited(Person p)
    {
        await JS.InvokeVoidAsync("console.log", $"OnSaveEdited called for {p?.Name} (Id={p?.Id})");
        // attach and update
        if (p != null)
        {
            var dbp = await Db.Personen.FindAsync(p.Id);
            if (dbp != null)
            {
                dbp.Name = p.Name;
                dbp.Geburtsort = p.Geburtsort;
                dbp.Geburtsdatum = p.Geburtsdatum;
                dbp.Verwandte = p.Verwandte;
                dbp.Notizen = p.Notizen;
                await Db.SaveChangesAsync();
                persons = await Db.Personen.Where(x => x.BenutzerId == Auth.UserId).ToListAsync();
            }
        }
        showEditModal = false;
        StateHasChanged();
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        editPerson = null;
    }

    private async Task RequestDeletePerson(Person p)
    {
        await JS.InvokeVoidAsync("console.log", $"RequestDeletePerson called for {p?.Name} (Id={p?.Id})");
        personToDelete = p;
        showConfirmDelete = true;
    }

    private async Task ConfirmDelete()
    {
        await JS.InvokeVoidAsync("console.log", $"ConfirmDelete called for {personToDelete?.Name} (Id={personToDelete?.Id})");
        if (personToDelete is not null)
        {
            await OnDeletePerson(personToDelete);
        }
        showConfirmDelete = false;
        personToDelete = null;
    }

    private void CancelDelete()
    {
        showConfirmDelete = false;
        personToDelete = null;
    }

    [Inject] private IJSRuntime JS { get; set; } = default!;

    private async Task ExportCsv()
    {
        if (persons is null || persons.Count == 0)
        {
            csvHref = null;
            return;
        }

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("Name;Geburtsort;Geburtsdatum;Verwandte;Notizen");
        foreach (var p in persons)
        {
            string line = $"{EscapeCsv(p.Name)};{EscapeCsv(p.Geburtsort)};{EscapeCsv(p.Geburtsdatum)};{EscapeCsv(p.Verwandte)};{EscapeCsv(p.Notizen)}";
            sb.AppendLine(line);
        }

        var csv = sb.ToString();
        var href = "data:text/csv;charset=utf-8," + Uri.EscapeDataString(csv);
        await JS.InvokeVoidAsync("TreeEditor.download", href, "personen.csv");
    }

    private static string EscapeCsv(string? s) => (s ?? string.Empty).Replace("\r", "").Replace("\n", " ").Replace(";", ",");

    private async Task OpenRelationshipModal(Person p)
    {
        selectedPerson = p;
        selectedPersonRelationships = await Db.Verwandtschaften
            .Where(v => v.PersonAId == p.Id || v.PersonBId == p.Id)
            .Include(v => v.PersonA)
            .Include(v => v.PersonB)
            .ToListAsync();
        newRelationshipPersonId = 0;
        newRelationshipType = string.Empty;
        showRelationshipModal = true;
    }

    private void CloseRelationshipModal()
    {
        showRelationshipModal = false;
        selectedPerson = null;
        selectedPersonRelationships = null;
    }

    private async Task AddRelationship()
    {
        if (selectedPerson != null && newRelationshipPersonId > 0 && !string.IsNullOrEmpty(newRelationshipType))
        {
            try
            {
                var verwandtschaft = new Verwandtschaft
                {
                    PersonAId = selectedPerson.Id,
                    PersonBId = newRelationshipPersonId,
                    Beziehungstyp = newRelationshipType
                };

                Db.Verwandtschaften.Add(verwandtschaft);
                await Db.SaveChangesAsync();

                // Reload relationships
                if (selectedPerson != null)
                {
                    selectedPersonRelationships = await Db.Verwandtschaften
                        .Where(v => v.PersonAId == selectedPerson.Id || v.PersonBId == selectedPerson.Id)
                        .Include(v => v.PersonA)
                        .Include(v => v.PersonB)
                        .ToListAsync();
                }

                newRelationshipPersonId = 0;
                newRelationshipType = string.Empty;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Fehler beim Hinzufügen der Verwandtschaft: {ex.Message}");
            }
        }
    }

    private async Task DeleteRelationship(int relationshipId)
    {
        var verwandtschaft = await Db.Verwandtschaften.FindAsync(relationshipId);
        if (verwandtschaft != null)
        {
            Db.Verwandtschaften.Remove(verwandtschaft);
            await Db.SaveChangesAsync();

            // Reload relationships
            if (selectedPerson != null)
            {
                selectedPersonRelationships = await Db.Verwandtschaften
                    .Where(v => v.PersonAId == selectedPerson.Id || v.PersonBId == selectedPerson.Id)
                    .Include(v => v.PersonA)
                    .Include(v => v.PersonB)
                    .ToListAsync();
            }

            StateHasChanged();
        }
    }

    // Render modals: Edit and Confirm Delete
    // These were previously only tracked by flags which caused warnings; rendering them uses the flags.
}

@if (showEditModal && editPerson is not null)
{
    <PersonEditModal EditPerson="editPerson" OnSave="OnSaveEdited" OnCancel="CloseEditModal" />
}

@if (showConfirmDelete && personToDelete is not null)
{
    <ConfirmDialog Title="Löschen bestätigen" Message="@($"Möchten Sie {personToDelete.Name} wirklich löschen?")" OnConfirm="ConfirmDelete" OnCancelCallback="CancelDelete" ConfirmText="Löschen" CancelText="Abbrechen" />
}

@if (showRelationshipModal && selectedPerson is not null)
{
    <div class="modal-backdrop-custom" @onclick="CloseRelationshipModal">
        <div class="modal-card" @onclick:stopPropagation style="max-width: 600px;">
            <div class="d-flex mb-3">
                <h5 class="mb-0">Verwandtschaften für @selectedPerson.Name</h5>
                <button class="btn btn-sm btn-link ms-auto" @onclick="CloseRelationshipModal">×</button>
            </div>

            <!-- Vorhandene Verwandtschaften -->
            @if (selectedPersonRelationships != null && selectedPersonRelationships.Count > 0)
            {
                <h6>Bestehende Verwandtschaften:</h6>
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    @foreach (var rel in selectedPersonRelationships)
                    {
                        var otherPerson = rel.PersonAId == selectedPerson.Id ? rel.PersonB?.Name : rel.PersonA?.Name;
                        <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-1">
                            <span>@otherPerson - @rel.Beziehungstyp</span>
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteRelationship(rel.Id)">Löschen</button>
                        </div>
                    }
                </div>
            }

            <!-- Neue Verwandtschaft hinzufügen -->
            <h6>Neue Verwandtschaft hinzufügen:</h6>
            <div class="mb-2">
                <label>Verwandte Person</label>
                <select class="form-control" @bind="newRelationshipPersonId">
                    <option value="0">-- Wähle eine Person --</option>
                    @foreach (var p in persons!.Where(x => x.Id != selectedPerson.Id))
                    {
                        <option value="@p.Id">@p.Name</option>
                    }
                </select>
            </div>

            <div class="mb-2">
                <label>Beziehungstyp</label>
                <select class="form-control" @bind="newRelationshipType">
                    <option value="">-- Wähle einen Beziehungstyp --</option>
                    <option value="Vater">Vater</option>
                    <option value="Mutter">Mutter</option>
                    <option value="Sohn">Sohn</option>
                    <option value="Tochter">Tochter</option>
                    <option value="Bruder">Bruder</option>
                    <option value="Schwester">Schwester</option>
                    <option value="Ehemann">Ehemann</option>
                    <option value="Ehefrau">Ehefrau</option>
                    <option value="Großvater">Großvater</option>
                    <option value="Großmutter">Großmutter</option>
                    <option value="Enkel">Enkel</option>
                    <option value="Enkelin">Enkelin</option>
                    <option value="Onkel">Onkel</option>
                    <option value="Tante">Tante</option>
                    <option value="Cousin">Cousin</option>
                    <option value="Cousine">Cousine</option>
                </select>
            </div>

            <div class="d-flex gap-2 mt-3">
                <button class="btn btn-primary" @onclick="AddRelationship" disabled="@(newRelationshipPersonId == 0 || string.IsNullOrEmpty(newRelationshipType))">Hinzufügen</button>
                <button class="btn btn-outline-secondary" @onclick="CloseRelationshipModal">Schließen</button>
            </div>
        </div>
    </div>
}
